name: Auth Service CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
      - name: Download modules
        working-directory: Kubernetes/auth-service/auth-service
        run: go mod download
      - name: Build
        working-directory: Kubernetes/auth-service/auth-service
        run: go build ./...
      - name: Unit tests (if present)
        working-directory: Kubernetes/auth-service/auth-service
        run: |
          if ls *_test.go >/dev/null 2>&1; then go test ./...; else echo "No Go tests"; fi
      - name: Build image
        working-directory: Kubernetes/auth-service/auth-service
        run: docker build -t auth-service:ci -f Dockerfile .

  lint:
    runs-on: ubuntu-latest
    needs: build_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.61.0
          working-directory: Kubernetes/auth-service/auth-service
          args: --timeout=5m

  security:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest
      - name: Run gosec (high only)
        working-directory: Kubernetes/auth-service/auth-service
        run: gosec -severity high ./...
      - name: Trivy SCA (fail on critical)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scan-ref: Kubernetes/auth-service/auth-service
          severity: CRITICAL
          exit-code: "1"

  docker_build_push:
    runs-on: ubuntu-latest
    needs: security
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image
        working-directory: Kubernetes/auth-service/auth-service
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          docker build -t auth-service:${COMMIT_SHA} -f Dockerfile .
          docker tag auth-service:${COMMIT_SHA} auth-service:latest
      - name: Trivy Container Scan (fail on critical)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: auth-service:${{ github.sha }}
          format: 'table'
          severity: CRITICAL
          exit-code: "1"
      - name: Login to OCI Registry
        run: |
          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login ${{ secrets.OCI_REGISTRY_URL }} -u "${{ secrets.OCI_USERNAME }}" --password-stdin
      - name: Push to OCIR
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          docker tag auth-service:${COMMIT_SHA} ${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/${{ secrets.PROJECT_NAME }}/auth-service:${COMMIT_SHA}
          docker tag auth-service:${COMMIT_SHA} ${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/${{ secrets.PROJECT_NAME }}/auth-service:latest
          docker push ${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/${{ secrets.PROJECT_NAME }}/auth-service:${COMMIT_SHA}
          docker push ${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/${{ secrets.PROJECT_NAME }}/auth-service:latest
      - name: Update GitOps manifest
        run: |
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          sed -i "s|image: ${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/${{ secrets.PROJECT_NAME }}/auth-service:.*|image: ${{ secrets.OCI_REGISTRY_URL }}/${{ secrets.OCI_NAMESPACE }}/${{ secrets.PROJECT_NAME }}/auth-service:${COMMIT_SHA}|g" gitops/manifests/auth-service/deployment.yaml
          git add gitops/manifests/auth-service/deployment.yaml
          git commit -m "[GitOps] Update auth-service image to ${COMMIT_SHA}" || echo "No changes to commit"
          git push origin main
